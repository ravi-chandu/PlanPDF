<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan PDF — All‑in‑one Local PDF Tools</title>
  <meta name="description" content="Free, private PDF tools that run in your browser. All processing is 100% local." />

  <!-- Security: Content Security Policy (compatible with inline JS + CDN libs we use) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data: blob:;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net;
    connect-src 'self';
    worker-src 'self' blob: https://cdn.jsdelivr.net;
    object-src 'none';
    frame-ancestors 'none';
  ">

  <!-- Fonts + PWA + social -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="icon" href="logo.png" type="image/png">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">

  <meta property="og:title" content="Plan PDF — All‑in‑one Local PDF Tools">
  <meta property="og:description" content="Clean, fast, privacy‑first PDF tools. 100% local processing.">
  <meta property="og:image" content="logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Plan PDF — All‑in‑one Local PDF Tools">
  <meta name="twitter:description" content="Clean, fast, privacy‑first PDF tools. 100% local processing.">
  <meta name="twitter:image" content="logo.png">

  <!-- Tailwind (dark mode follows system by default via media) -->
  <script>
    tailwind = { config: { darkMode: 'media' } }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html,body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .tab-content{display:none}
    .tab-content.active{display:block}
  </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="max-w-4xl w-full bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 border border-gray-200/60 dark:border-gray-700">

    <!-- Header -->
    <header class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <img src="logo.png" alt="Plan PDF logo" class="w-12 h-12 rounded-xl ring-1 ring-black/5 dark:ring-white/10 object-cover" />
        <div>
          <h1 class="text-3xl font-bold">Plan PDF</h1>
          <p class="text-sm text-gray-600 dark:text-gray-400">Clean, fast, privacy‑first tools</p>
        </div>
      </div>
      <p class="text-xs md:text-sm text-gray-600 dark:text-gray-300 italic bg-gray-100 dark:bg-gray-700/70 px-3 py-2 rounded-lg">
        100% local processing — your files never leave your device.
      </p>
    </header>

    <!-- Tabs Navigation (only 4 tools) -->
    <nav class="bg-gray-100 dark:bg-gray-700 p-1 rounded-xl mb-6 shadow-inner">
      <div class="flex flex-wrap text-center font-semibold">
        <button class="tab-button flex-1 py-3 px-2 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-all" data-tab="merge" title="Shortcut: M">Merge</button>
        <button class="tab-button flex-1 py-3 px-2 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-all" data-tab="split" title="Shortcut: S">Split</button>
        <button class="tab-button flex-1 py-3 px-2 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-all" data-tab="compress" title="Shortcut: C">Compress</button>
        <button class="tab-button flex-1 py-3 px-2 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-all" data-tab="convert" title="Shortcut: V">Convert</button>
      </div>
    </nav>

    <!-- Tools Content -->
    <main id="tool-container">

      <!-- Merge -->
      <section id="merge" class="tab-content">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3l7 4-7 4-7-4 7-4zm0 14l7-4m-7 4l-7-4m7 8l7-4m-7 4l-7-4"/></svg>
          Merge PDF Files
        </h2>
        <div id="merge-dropzone" class="dropzone p-8 mb-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
          <p class="text-gray-600 dark:text-gray-300">Drop PDF files here or <span class="text-indigo-600 dark:text-indigo-400 underline">choose files</span></p>
          <input id="merge-file-input" type="file" accept="application/pdf" multiple class="hidden" />
        </div>
        <div id="merge-file-list" class="space-y-2 mb-4"></div>
        <div class="flex flex-col md:flex-row items-center gap-3">
          <input id="merge-name-input" type="text" value="merged.pdf" class="flex-1 w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Output file name" />
          <button id="btn-merge" class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors disabled:bg-gray-400/60 dark:disabled:bg-gray-600/60">Merge & Download</button>
          <button id="btn-clear-merge" class="w-full md:w-auto px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors disabled:opacity-50">Clear</button>
        </div>
        <p id="merge-status" aria-live="polite" class="mt-4 text-sm text-gray-600 dark:text-gray-400"></p>
      </section>

      <!-- Split -->
      <section id="split" class="tab-content">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121a3 3 0 10-4.242 4.242m4.242-4.242L21 7.5m-6.879 6.621L3 7.5M7.5 19.5a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm9 0a1.5 1.5 0 110-3 1.5 1.5 0 010 3z"/></svg>
          Split / Extract Pages
        </h2>
        <div id="split-dropzone" class="dropzone p-8 mb-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
          <p class="text-gray-600 dark:text-gray-300">Drop one PDF here or <span class="text-indigo-600 dark:text-indigo-400 underline">choose a file</span></p>
          <input id="split-file-input" type="file" accept="application/pdf" class="hidden" />
        </div>
        <div id="split-file-list" class="space-y-2 mb-4"></div>

        <div class="flex flex-col md:flex-row items-center gap-3 mb-3">
          <input id="split-range-input" type="text" class="flex-1 w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Pages to extract (e.g., 1-3, 5)" />
          <input id="split-name-input" type="text" value="extract.pdf" class="flex-1 w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Output file name (default: extract.pdf)" />
          <button id="btn-split" class="w-full md:w-auto px-6 py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 transition-colors disabled:bg-gray-400/60 dark:disabled:bg-gray-600/60">Extract Pages</button>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 mb-3">
          <button id="btn-split-all" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm">Split all</button>
          <button id="btn-split-odd" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm">Odd pages</button>
          <button id="btn-split-even" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover-bg-gray-600 transition-colors text-sm">Even pages</button>
          <button id="btn-split-first" class="px-4 py-2 bg-gray-2 00 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm">First half</button>
          <button id="btn-split-second" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-semibold rounded-lg shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-sm">Second half</button>
        </div>
        <div class="flex gap-2 mb-2">
          <button id="btn-clear-split" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-semibold rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">Clear</button>
        </div>
        <p id="split-status" aria-live="polite" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></p>
      </section>

      <!-- Compress -->
      <section id="compress" class="tab-content">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h6m6 0h6M8 6l-4 4 4 4M16 6l4 4-4 4M10 21v-6m0 0l-4 4m4-4l4 4"/></svg>
          Compress PDF
        </h2>
        <div id="compress-dropzone" class="dropzone p-8 mb-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
          <p class="text-gray-600 dark:text-gray-300">Drop one PDF here or <span class="text-indigo-600 dark:text-indigo-400 underline">choose a file</span></p>
          <input id="compress-file-input" type="file" accept="application/pdf" class="hidden" />
        </div>
        <div id="compress-file-list" class="space-y-2 mb-4"></div>
        <div class="flex flex-col md:flex-row items-center gap-3">
          <input id="compress-name-input" type="text" class="flex-1 w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Output file name" />
          <button id="btn-compress" class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors disabled:bg-gray-400/60 dark:disabled:bg-gray-600/60">Compress & Download</button>
        </div>
        <p id="compress-status" aria-live="polite" class="mt-4 text-sm text-gray-600 dark:text-gray-400"></p>
      </section>

      <!-- Convert -->
      <section id="convert" class="tab-content">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2H5a2 2 0 01-2-2V5z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13l4-4 4 4 4-4 6 6"/></svg>
          Convert PDF to Images
        </h2>
        <div id="convert-dropzone" class="dropzone p-8 mb-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
          <p class="text-gray-600 dark:text-gray-300">Drop one PDF here or <span class="text-indigo-600 dark:text-indigo-400 underline">choose a file</span></p>
          <input id="convert-file-input" type="file" accept="application/pdf" class="hidden" />
        </div>
        <div id="convert-file-list" class="space-y-2 mb-4"></div>
        <div class="flex flex-col gap-3">
          <div class="flex flex-col md:flex-row items-center gap-3">
            <input id="convert-name-input" type="text" class="flex-1 w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Filename prefix (optional)" />
            <button id="btn-convert" class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors disabled:bg-gray-400/60 dark:disabled:bg-gray-600/60">Download Images</button>
          </div>
          <label class="inline-flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
            <input id="convert-zip-toggle" type="checkbox" class="w-4 h-4">
            <span>Package as ZIP (off = separate image files)</span>
          </label>
        </div>
        <p id="convert-status" aria-live="polite" class="mt-4 text-sm text-gray-600 dark:text-gray-400"></p>
      </section>
    </main>

    <!-- About & FAQ -->
    <section class="mt-10 border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-xl font-bold mb-2">About</h3>
      <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">Plan PDF is a clean, lightweight, and private set of PDF tools built to run entirely in your browser. No uploads, no servers, just your files on your device.</p>
      <h3 class="text-xl font-bold mb-2">FAQ</h3>
      <details class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-3 mb-2"><summary class="cursor-pointer font-semibold">Do my files ever leave my device?</summary><p class="mt-2 text-sm text-gray-700 dark:text-gray-300">No. Everything runs locally using Web APIs and open‑source libraries. You can even go offline after the page loads.</p></details>
      <details class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-3 mb-2"><summary class="cursor-pointer font-semibold">Why is image conversion basic?</summary><p class="mt-2 text-sm text-gray-700 dark:text-gray-300">High‑fidelity PDF→image rendering needs heavier engines (e.g., pdf.js). This starter uses a lightweight placeholder so the app stays fast.</p></details>
    </section>

    <!-- Alert -->
    <div id="alert-box" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 max-w-sm w-full">
        <h3 id="alert-title" class="text-lg font-bold text-gray-900 dark:text-white mb-2"></h3>
        <p id="alert-message" class="text-gray-700 dark:text-gray-300 mb-4"></p>
        <button id="alert-close" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">OK</button>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <!-- SortableJS for drag-to-reorder (Merge) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <!-- pdf.js for thumbnails -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    // Configure pdf.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
  </script>

  <script>
    // ------- Helpers -------
    const qs = (s)=>document.querySelector(s);
    const qsa = (s)=>[...document.querySelectorAll(s)];

    function customAlert(title, message){
      qs('#alert-title').textContent = title;
      qs('#alert-message').textContent = message;
      const box = qs('#alert-box');
      box.classList.remove('hidden');
      box.classList.add('flex');
    }
    qs('#alert-close').onclick = ()=>{
      const box = qs('#alert-box');
      box.classList.remove('flex');
      box.classList.add('hidden');
    };

    const humanSize = (b)=>{
      const u=['B','KB','MB','GB']; let i=0, n=b||0; while(n>=1024 && i<u.length-1){n/=1024; i++} return n.toFixed(1)+' '+u[i];
    };
    const isPDF = (f)=>!!f && f.type==='application/pdf';

    function parseRanges(text, count){
      const clean=(text||'').replace(/–/g,'-');
      const set=new Set();
      clean.split(',').map(s=>s.trim()).filter(Boolean).forEach(part=>{
        if(part.includes('-')){
          const [a,b]=part.split('-').map(n=>parseInt(n,10));
          if(!isNaN(a)&&!isNaN(b)){
            const s=Math.max(1, Math.min(a,b)), e=Math.min(count, Math.max(a,b));
            for(let p=s;p<=e;p++) set.add(p-1);
          }
        }else{
          const n=parseInt(part,10);
          if(!isNaN(n) && n>=1 && n<=count) set.add(n-1);
        }
      });
      return [...set].sort((x,y)=>x-y);
    }

    async function createThumbCanvas(file, maxW=80){
      try{
        const bytes = new Uint8Array(await file.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({data: bytes}).promise;
        const page = await pdf.getPage(1);
        const viewport1 = page.getViewport({scale: 1});
        const scale = Math.min(1, maxW / viewport1.width);
        const viewport = page.getViewport({scale});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = Math.round(viewport.width);
        canvas.height = Math.round(viewport.height);
        await page.render({canvasContext: ctx, viewport}).promise;
        try { pdf.destroy?.(); } catch {}
        return canvas;
      }catch(err){
        console.warn('thumb fail', err);
        const ph = document.createElement('div');
        ph.className = 'w-16 h-20 bg-gray-200 dark:bg-gray-700 rounded';
        return ph;
      }
    }

    // ------- Tabs -------
    const tabs = qsa('.tab-button');
    const contents = qsa('.tab-content');
    function switchTab(id){
      tabs.forEach(btn=>{
        const active = btn.dataset.tab===id;
        btn.classList.toggle('bg-indigo-600', active);
        btn.classList.toggle('text-white', active);
        btn.classList.toggle('hover:bg-gray-200', !active);
        btn.classList.toggle('dark:hover:bg-gray-600', !active);
      });
      contents.forEach(c=>c.classList.toggle('active', c.id===id));
    }
    tabs.forEach(btn=>btn.addEventListener('click',()=>switchTab(btn.dataset.tab)));
    switchTab('merge');

    // Keyboard shortcuts for tabs (m/s/c/v)
    document.addEventListener('keydown', (e)=>{
      const tag = document.activeElement?.tagName;
      if(['INPUT','TEXTAREA','SELECT'].includes(tag)) return;
      const k = e.key.toLowerCase();
      const map = { m:'merge', s:'split', c:'compress', v:'convert' };
      if(map[k]){ switchTab(map[k]); }
    });

    // ------- Drag & Drop (a11y + guards) -------
    function setupDragAndDrop(dropzoneId, inputId, handler, multiple=false){
      const dz = document.getElementById(dropzoneId);
      const fi = document.getElementById(inputId);

      // Accessibility: focusable & button semantics
      dz.setAttribute('tabindex','0');
      dz.setAttribute('role','button');
      dz.setAttribute('aria-label','Upload PDF files');

      dz.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          fi.click();
        }
      });

      dz.addEventListener('dragover',e=>{e.preventDefault(); dz.classList.add('bg-gray-50','dark:bg-gray-700')});
      dz.addEventListener('dragleave',()=>{dz.classList.remove('bg-gray-50','dark:bg-gray-700')});
      dz.addEventListener('drop',async e=>{
        e.preventDefault(); dz.classList.remove('bg-gray-50','dark:bg-gray-700');
        const fs = [...(e.dataTransfer?.files || [])];
        if (!fs.length) return;
        const files = multiple ? fs : [fs[0]];
        handler(files);
      });
      fi.addEventListener('change',e=>{
        const fs = [...(e.target?.files || [])];
        if (!fs.length) return;
        const files = multiple ? fs : [fs[0]];
        handler(files);
      });
      dz.addEventListener('click',()=>fi.click());
    }

    function renderSingleFileList(files, listId, nameInputId, statusId, onRemove){
      const list = document.getElementById(listId);
      const nameInput = nameInputId ? document.getElementById(nameInputId) : null;
      const status = statusId ? document.getElementById(statusId) : null;
      list.innerHTML='';
      if(files.length===0){ if(nameInput) nameInput.value=''; if(status) status.textContent=''; return; }
      const file = files[0];
      const row = document.createElement('div'); row.className='flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg shadow';
      const left = document.createElement('div'); left.className='flex items-center gap-3';
      const thumbWrap = document.createElement('div'); thumbWrap.className='w-16 h-20 bg-gray-200 dark:bg-gray-600 rounded overflow-hidden flex items-center justify-center';
      createThumbCanvas(file, 80).then(cv=>{ thumbWrap.innerHTML=''; thumbWrap.appendChild(cv); });
      const info = document.createElement('div'); info.className='flex flex-col text-sm text-gray-900 dark:text-gray-100';
      info.innerHTML=`<span>${file.name}</span><span class=\"text-xs text-gray-600 dark:text-gray-300\">${humanSize(file.size)}</span>`;
      left.append(thumbWrap, info);
      const controls = document.createElement('div');
      const rm = document.createElement('button'); rm.className='text-red-500 hover:text-red-600'; rm.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
      rm.onclick = onRemove || (()=>{ list.innerHTML=''; if(nameInput) nameInput.value=''; if(status) status.textContent=''; });
      controls.appendChild(rm);
      row.append(left, controls);
      list.appendChild(row);
    }

    // ------- Merge (with thumbnails + drag reorder) -------
    const mergeState = { files: [] }; // entries: {id, file}
    let mergeIdCounter = 0;
    const mergeList = document.getElementById('merge-file-list');
    const mergeNameInput = document.getElementById('merge-name-input');
    const mergeStatus = document.getElementById('merge-status');
    const btnMerge = document.getElementById('btn-merge');
    const btnClearMerge = document.getElementById('btn-clear-merge');
    let mergeSortable = null;

    function renderMergeList(){
      mergeList.innerHTML='';
      mergeState.files.forEach((entry)=>{
        const { file, id } = entry;
        const row=document.createElement('div'); row.className='flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg shadow cursor-move';
        row.dataset.id = id;

        const left = document.createElement('div'); left.className='flex items-center gap-3';
        const thumbWrap = document.createElement('div'); thumbWrap.className='w-16 h-20 bg-gray-200 dark:bg-gray-600 rounded overflow-hidden flex items-center justify-center';
        createThumbCanvas(file, 80).then(cv=>{ thumbWrap.innerHTML=''; thumbWrap.appendChild(cv); });
        const info=document.createElement('div'); info.className='text-sm text-gray-900 dark:text-gray-100'; info.textContent=`${file.name} (${humanSize(file.size)})`;

        const ctrl=document.createElement('div');
        const rm=document.createElement('button'); rm.className='text-red-500 hover:text-red-600'; rm.innerHTML='<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
        rm.onclick=()=>{ mergeState.files = mergeState.files.filter(e=>e.id!==id); renderMergeList(); };

        left.append(thumbWrap, info);
        ctrl.append(rm); row.append(left, ctrl); mergeList.appendChild(row);
      });

      // Enable/disable buttons
      btnMerge.disabled = mergeState.files.length < 2;
      btnClearMerge.disabled = mergeState.files.length === 0;

      // Create Sortable once
      if(!mergeSortable){
        mergeSortable = new Sortable(mergeList, {
          animation: 150,
          onEnd: ()=>{
            const orderIds = [...mergeList.children].map(el=>el.dataset.id);
            const byId = Object.fromEntries(mergeState.files.map(e=>[e.id, e]));
            mergeState.files = orderIds.map(id=>byId[id]).filter(Boolean);
          }
        });
      }
    }

    function handleMerge(files){
      const pdfs = files.filter(isPDF);
      if(pdfs.length){
        mergeState.files.push(...pdfs.map(f=>({ id: 'f'+(mergeIdCounter++), file: f })));
        renderMergeList();
        mergeStatus.textContent=`Added ${pdfs.length} file(s). Drag to reorder.`;
      }
      else if(files.length){ customAlert('Invalid File Type','Please select only PDF files.'); }
    }

    btnMerge.onclick = async ()=>{
      if(mergeState.files.length<2) return; btnMerge.disabled=true; mergeStatus.textContent='Merging...';
      try{
        const { PDFDocument } = PDFLib; const out = await PDFDocument.create();
        for(const entry of mergeState.files){
          const bytes = await entry.file.arrayBuffer(); const src = await PDFDocument.load(bytes);
          const pages = await out.copyPages(src, src.getPageIndices()); pages.forEach(p=>out.addPage(p));
        }
        const outBytes = await out.save();
        saveAs(new Blob([outBytes], {type:'application/pdf'}), (mergeNameInput.value && mergeNameInput.value.trim()) || 'merged.pdf');
        mergeStatus.textContent='Successfully merged and downloaded!';
      }catch(err){ customAlert('Merge Failed', `An error occurred: ${err.message}`); mergeStatus.textContent='Merging failed.'; }
      finally{ btnMerge.disabled=false; }
    };

    btnClearMerge.onclick = ()=>{ mergeState.files=[]; renderMergeList(); mergeStatus.textContent='File list cleared.'; mergeNameInput.value='merged.pdf'; };

    // ------- Split -------
    const splitState = { file:null, doc:null };
    const splitStatus = document.getElementById('split-status');
    const splitRangeInput = document.getElementById('split-range-input');
    const splitNameInput = document.getElementById('split-name-input');
    const btnSplit = document.getElementById('btn-split');
    const btnSplitAll = document.getElementById('btn-split-all');
    const btnSplitOdd = document.getElementById('btn-split-odd');
    const btnSplitEven = document.getElementById('btn-split-even');
    const btnSplitFirst = document.getElementById('btn-split-first');
    const btnSplitSecond = document.getElementById('btn-split-second');
    const btnClearSplit = document.getElementById('btn-clear-split');

    function handleSplit(files){
      const f = files[0]; if(!f) return; if(!isPDF(f)){ customAlert('Invalid File Type','Please select a single PDF.'); return; }
      splitState.file = f; splitState.doc = null;
      renderSingleFileList([f], 'split-file-list', 'split-name-input', 'split-status', ()=>{ splitState.file=null; splitState.doc=null; renderSingleFileList([], 'split-file-list', 'split-name-input', 'split-status'); splitRangeInput.value=''; splitStatus.textContent=''; });
      splitStatus.textContent = `Loaded: ${f.name}`;
      [btnSplit, btnSplitAll, btnSplitOdd, btnSplitEven, btnSplitFirst, btnSplitSecond].forEach(b=>b.disabled=false);
    }

    btnSplit.onclick = async ()=>{
      if(!splitState.file) return; const textRanges = splitRangeInput.value; splitStatus.textContent='Processing...'; btnSplit.disabled=true;
      try{
        if(!splitState.doc){ const bytes = await splitState.file.arrayBuffer(); splitState.doc = await PDFLib.PDFDocument.load(bytes); }
        const total = splitState.doc.getPageCount(); const idx = parseRanges(textRanges, total);
        if(idx.length===0){ customAlert('Invalid Range', `Please enter valid page ranges within 1–${total}.`); splitStatus.textContent=''; return; }
        const out = await PDFLib.PDFDocument.create(); const pages = await out.copyPages(splitState.doc, idx); pages.forEach(p=>out.addPage(p));
        const outBytes = await out.save();
        const name = (splitNameInput.value && splitNameInput.value.trim()) || 'extract.pdf';
        saveAs(new Blob([outBytes],{type:'application/pdf'}), name);
        splitStatus.textContent='Pages extracted and downloaded!';
      }catch(err){ customAlert('Extraction Failed', `An error occurred: ${err.message}`); splitStatus.textContent='Extraction failed.'; }
      finally{ btnSplit.disabled=false; }
    };

    btnSplitAll.onclick = async ()=>{
      if(!splitState.file) return; splitStatus.textContent='Splitting...'; btnSplitAll.disabled=true;
      try{
        if(!splitState.doc){ const bytes = await splitState.file.arrayBuffer(); splitState.doc = await PDFLib.PDFDocument.load(bytes); }
        const total = splitState.doc.getPageCount(); const base = splitState.file.name.replace(/\.pdf$/i,'');
        for(let i=0;i<total;i++){
          const out = await PDFLib.PDFDocument.create(); const [p] = await out.copyPages(splitState.doc,[i]); out.addPage(p); const bytes = await out.save();
          saveAs(new Blob([bytes],{type:'application/pdf'}), `${base}_page_${i+1}.pdf`);
        }
        splitStatus.textContent='Successfully split and downloaded every page!';
      }catch(err){ customAlert('Split Failed', `An error occurred: ${err.message}`); splitStatus.textContent='Splitting failed.'; }
      finally{ btnSplitAll.disabled=false; }
    };

    async function ensureDoc(){
      if(!splitState.file) return null; if(!splitState.doc){ const bytes = await splitState.file.arrayBuffer(); splitState.doc = await PDFLib.PDFDocument.load(bytes); } return splitState.doc;
    }
    btnSplitOdd.onclick = async ()=>{ const doc = await ensureDoc(); if(!doc) return; const total = doc.getPageCount(); const arr=[]; for(let i=1;i<=total;i+=2) arr.push(i); splitRangeInput.value = arr.join(','); splitStatus.textContent='Selected odd pages.'; };
    btnSplitEven.onclick = async ()=>{ const doc = await ensureDoc(); if(!doc) return; const total = doc.getPageCount(); const arr=[]; for(let i=2;i<=total;i+=2) arr.push(i); splitRangeInput.value = arr.join(','); splitStatus.textContent='Selected even pages.'; };
    btnSplitFirst.onclick = async ()=>{ const doc = await ensureDoc(); if(!doc) return; const total = doc.getPageCount(); const half = Math.ceil(total/2); splitRangeInput.value = `1-${half}`; splitStatus.textContent='Selected first half.'; };
    btnSplitSecond.onclick = async ()=>{ const doc = await ensureDoc(); if(!doc) return; const total = doc.getPageCount(); const half = Math.floor(total/2); splitRangeInput.value = `${half+1}-${total}`; splitStatus.textContent='Selected second half.'; };

    btnClearSplit.onclick = ()=>{ splitState.file=null; splitState.doc=null; renderSingleFileList([], 'split-file-list', 'split-name-input', 'split-status'); splitRangeInput.value=''; splitNameInput.value='extract.pdf'; splitStatus.textContent='Cleared.'; [btnSplit, btnSplitAll, btnSplitOdd, btnSplitEven, btnSplitFirst, btnSplitSecond].forEach(b=>b.disabled=true); };

    // ------- Compress -------
    const compressState = { file:null };
    const compressStatus = document.getElementById('compress-status');
    const compressNameInput = document.getElementById('compress-name-input');
    const btnCompress = document.getElementById('btn-compress');
    function handleCompress(files){ const f = files[0]; if(!f) return; if(!isPDF(f)){ customAlert('Invalid File Type','Please select a single PDF.'); return;} compressState.file=f; renderSingleFileList([f],'compress-file-list','compress-name-input','compress-status',()=>{compressState.file=null; renderSingleFileList([], 'compress-file-list','compress-name-input','compress-status');}); btnCompress.disabled=false; }
    btnCompress.onclick = async ()=>{ if(!compressState.file) return; compressStatus.textContent='Compressing... (pdf-lib compression is limited)'; btnCompress.disabled=true; try{ const bytes = await compressState.file.arrayBuffer(); const pdfDoc = await PDFLib.PDFDocument.load(bytes,{ignoreEncryption:true}); const out = await pdfDoc.save(); saveAs(new Blob([out],{type:'application/pdf'}), (compressNameInput.value||`compressed_${compressState.file.name}`)); compressStatus.textContent='Done.'; }catch(err){ customAlert('Compression Failed', `An error occurred: ${err.message}`); compressStatus.textContent='Compression failed.'; } finally{ btnCompress.disabled=false; } };

    // ------- Convert (placeholder renderer) -------
    const convertState = { file:null };
    const convertStatus = document.getElementById('convert-status');
    const btnConvert = document.getElementById('btn-convert');
    const convertNameInput = document.getElementById('convert-name-input');
    const convertZipToggle = document.getElementById('convert-zip-toggle');

    function handleConvert(files){ const f = files[0]; if(!f) return; if(!isPDF(f)){ customAlert('Invalid File Type','Please select a single PDF.'); return;} convertState.file=f; renderSingleFileList([f],'convert-file-list','convert-name-input','convert-status',()=>{convertState.file=null; renderSingleFileList([], 'convert-file-list','convert-name-input','convert-status');}); btnConvert.disabled=false; }

    const canvasToBlob = (canvas, type='image/jpeg', quality=0.92)=> new Promise(res=> canvas.toBlob(b=>res(b), type, quality));

    btnConvert.onclick = async ()=>{
      if(!convertState.file) return; btnConvert.disabled=true;
      try{
        const bytes = await convertState.file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(bytes);
        const total = pdfDoc.getPageCount();
        const base = (convertNameInput.value && convertNameInput.value.trim()) || convertState.file.name.replace(/\.pdf$/i,'');

        if(!convertZipToggle.checked){
          convertStatus.textContent = `Creating ${total} images…`;
          for(let i=0;i<total;i++){
            const page = pdfDoc.getPage(i);
            const { width, height } = page.getSize();
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = Math.round(width); canvas.height = Math.round(height);
            // Placeholder render
            ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = '#000'; ctx.font = '16px Arial'; ctx.fillText(`Placeholder image for page ${i+1}`, 10, 30);
            const blob = await canvasToBlob(canvas, 'image/jpeg', 0.92);
            saveAs(blob, `${base}_page_${i+1}.jpeg`);
          }
          convertStatus.textContent = `Downloaded ${total} image file(s).`;
        } else {
          convertStatus.textContent='Zipping images…';
          const zip = new JSZip();
          for(let i=0;i<total;i++){
            const page = pdfDoc.getPage(i);
            const { width, height } = page.getSize();
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = Math.round(width); canvas.height = Math.round(height);
            ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = '#000'; ctx.font = '16px Arial'; ctx.fillText(`Placeholder image for page ${i+1}`, 10, 30);
            const blob = await canvasToBlob(canvas, 'image/jpeg', 0.92);
            zip.file(`${base}_page_${i+1}.jpeg`, blob);
          }
          const blobZip = await zip.generateAsync({type:'blob'});
          saveAs(blobZip, `${base}.zip`);
          convertStatus.textContent='ZIP downloaded.';
        }
      }catch(err){ customAlert('Conversion Failed', `An error occurred: ${err.message}`); convertStatus.textContent='Conversion failed.'; }
      finally{ btnConvert.disabled=false; }
    };

    // ------- Init listeners -------
    setupDragAndDrop('merge-dropzone','merge-file-input',handleMerge,true);
    setupDragAndDrop('split-dropzone','split-file-input',handleSplit);
    setupDragAndDrop('compress-dropzone','compress-file-input',handleCompress);
    setupDragAndDrop('convert-dropzone','convert-file-input',handleConvert);

    // Disable all action buttons on first load (handlers enable later)
    [
      '#btn-merge',
      '#btn-split', '#btn-split-all', '#btn-split-odd', '#btn-split-even', '#btn-split-first', '#btn-split-second',
      '#btn-compress',
      '#btn-convert'
    ].forEach(sel => { const el = document.querySelector(sel); if (el) el.disabled = true; });
  </script>

  <!-- Register service worker for offline support -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>
</body>
</html>
